<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elmohaseb Academy | ููุญุฉ ุงูุทุงูุจ</title>
    <link rel="icon" href="img/logo.jpg" type="image/jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css?v=1.3">
    <style>
        /* Only keeping page-specific tweaks that aren't in style.css yet */
        .dashboard-grid {
            margin-top: 2rem;
        }

        .subject-card.locked {
            opacity: 0.6;
            filter: grayscale(1);
            cursor: not-allowed;
            position: relative;
            pointer-events: none;
            /* Disable clicks */
        }

        .subject-card.locked::after {
            content: '๐';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }
    </style>
    <!-- Load Appwrite SDK and Config -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="js/appwrite-config.js?v=1.1"></script>
    <script src="js/db-appwrite.js?v=1.1"></script>
    <script src="js/security.js?v=2.0"></script>
    <script>
        // Initial security logic moved to js/security.js


        // --- LOGIC ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.initSecurity) window.initSecurity();

            // Check Login
            const displayName = localStorage.getItem('user_display_name');
            const userEmail = localStorage.getItem('user_email');

            if (!userEmail) {
                // console.log("No user logged in (Dev Mode)");
                // Redirect if strict: window.location.href = 'login.html';
            }

            // Set Welcome Message
            const nameToDisplay = displayName || (userEmail ? userEmail.split('@')[0] : 'ุทุงูุจ');
            document.getElementById('welcomeMsg').textContent = `ูุฑุญุจุงุ ${nameToDisplay}`;


            document.getElementById('logoutBtn').addEventListener('click', async () => {
                localStorage.removeItem('user_email');
                localStorage.removeItem('user_display_name');
                window.location.href = 'login.html';
            });

            // Security Warning Display Logic
            window.closeSecurityWarning = function () {
                document.getElementById('security-warning-modal').style.display = 'none';
                sessionStorage.setItem('security_warned', 'true');
            };

            if (!sessionStorage.getItem('security_warned')) {
                document.getElementById('security-warning-modal').style.display = 'flex';
            }

            // --- Subject Permissions Logic (Real-time Sync) ---
            async function syncPermissions() {
                console.log("๐ Syncing permissions...");
                const userId = localStorage.getItem('user_id');

                if (userId && window.dbUserGet) {
                    try {
                        const currentUser = await window.dbUserGet(userId);
                        if (currentUser) {
                            console.log("โ Current user data fetched:", currentUser);
                            localStorage.setItem('user_permitted_subjects', currentUser.permittedSubjects || "");
                        } else {
                            console.warn("โ๏ธ Could not fetch user data for ID:", userId);
                        }
                    } catch (e) { console.error("Sync error:", e); }
                }

                // Default to ALL if nothing is set in localStorage yet (for first-time migration)
                let permittedStr = localStorage.getItem('user_permitted_subjects');
                if (permittedStr === null) {
                    permittedStr = "math,geo,eng,fr"; // Initial fallback
                }

                const permitted = permittedStr.split(',').filter(s => s.trim());
                console.log("๐ Permitted subjects:", permitted);

                const subjectCards = document.querySelectorAll('.subject-card');
                let visibleCount = 0;

                subjectCards.forEach(card => {
                    const href = card.getAttribute('data-href') || card.getAttribute('href') || "";
                    if (!card.hasAttribute('data-href')) card.setAttribute('data-href', href); // Save original href

                    const url = new URL(href, window.location.origin);
                    const subjectId = url.searchParams.get('id');

                    if (subjectId) {
                        if (permitted.length > 0 && !permitted.includes(subjectId)) {
                            card.classList.add('locked');
                            card.removeAttribute('href'); // Remove link
                            card.style.display = 'flex'; // Ensure it's visible
                        } else {
                            card.classList.remove('locked');
                            card.setAttribute('href', card.getAttribute('data-href')); // Restore link
                            card.style.display = 'flex';
                            visibleCount++;
                        }
                    }
                });

                if (visibleCount === 0 && permittedStr !== "") {
                    console.warn("๐ซ No matching subjects found for permissions:", permitted);
                }

                if (visibleCount === 0) {
                    const grid = document.querySelector('.dashboard-grid');
                    grid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; background: #fff; border-radius: 16px; border: 2px dashed #ddd;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">๐</div>
                            <h3 style="color: #333; margin-bottom: 0.5rem;">ูุง ููุฌุฏ ููุงุฏ ููุนูุฉ ุญุงููุงู</h3>
                            <p style="color: #666;">ูุฑุฌู ุงูุชูุงุตู ูุน ุงูุฅุฏุงุฑุฉ ูุชูุนูู ุงูููุงุฏ ุงูุฎุงุตุฉ ุจู.</p>
                            <a href="tel:01027783480" style="display: inline-block; margin-top: 1rem; color: #0d47a1; font-weight: bold; text-decoration: none; border: 1px solid #0d47a1; padding: 8px 20px; border-radius: 8px;">ุงุชุตู ุจุงูุฏุนู ุงูููู ๐</a>
                        </div>
                    `;
                }
            }

            syncPermissions();
        });
    </script>
</head>

<body>
    <div id="security-overlay">
        <h2>โ๏ธ ุชุญุฐูุฑ ุฃููู</h2>
        <p>ุชู ุงูุชุดุงู ูุญุงููุฉ ุชุตููุฑ ุฃู ุชุณุฌูู ููุดุงุดุฉ.</p>
        <p>ุณูุชู ุฅุบูุงู ุงูุญุณุงุจ ูู ุญุงูุฉ ุงูุชูุฑุงุฑ.</p>
    </div>

    <!-- Security Warning Modal (Shows once per session) -->
    <div id="security-warning-modal" style="display: none;">
        <div class="warning-card">
            <h2>โ๏ธ ุชูุจูู ุฃููู ูุงู ุฌุฏุงู</h2>
            <p>ูุฑุญุจุงู ุจู ูู ููุตุฉ ุงููุญุงุณุจ ุงูุชุนููููุฉ. ูุฑุฌู ุงูุนูู ุฃู ุฌููุน ุงููุญุงุถุฑุงุช ูุงููููุงุช ูุญููุฉ ุจุญููู ุงูุทุจุน ูุงููุดุฑ
                ููุฑุงูุจุฉ ุจูุธุงู ุญูุงูุฉ ูุชุทูุฑ.</p>
            <p style="color: #dc3545; font-weight: bold;">โ๏ธ ุฃู ูุญุงููุฉ ูุชุตููุฑ ุงูุดุงุดุฉ ุฃู ุชุณุฌูู ุงููุญุงุถุฑุงุช ุณุชุคุฏู ุฅูู ุฅุบูุงู
                ุญุณุงุจู ููุฑุงู ูุจุดูู ููุงุฆู ุฏูู ุฅุดุนุงุฑ ุขุฎุฑุ ูุน ููุงุญูุฉ ูุงููููุฉ.</p>
            <button class="btn-confirm" onclick="closeSecurityWarning()">ุฃูุงูู ูุฃุชุนูุฏ ุจุงูุงูุชุฒุงู โ</button>
        </div>
    </div>

    <nav class="main-nav">
        <div class="container nav-container">
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="img/logo.jpg" alt="Logo" style="height: 50px; border-radius: 8px;">
                <h1 class="brand-text"
                    style="font-size: 2.5rem; margin: 0; font-weight: 900; letter-spacing: 2px; color: #ffd700; text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 15px rgba(255,215,0,0.6);">
                    ELMOHASEB ACADEMY</h1>
            </div>

            <div class="nav-actions">
                <div class="user-profile">
                    <span id="welcomeMsg" class="welcome-msg">ูุฑุญุจุง</span>
                </div>
                <div class="nav-separator"></div>
                <button id="logoutBtn" class="logout-btn">ุฎุฑูุฌ ๐ช</button>
            </div>
        </div>
    </nav>

    <div class="header-section">
        <div class="container">
            <h1 class="brand-text" style="color: white;">ููุญุฉ ุงูุชุญูู ุงูุฎุงุตุฉ ุจู</h1>
            <p style="color: white; margin-top: 0.5rem; opacity: 0.9;">ูุฑุญุจุงู ุจู ูู ููุตุชู ุงูุชุนููููุฉ ุงููุนุชูุฏุฉ</p>
        </div>
    </div>

    <!-- Persistent Warning Banner -->
    <div class="persistent-warning">
        <span>โ๏ธ ุชูุจูู ุฃููู: ุงูุชุตููุฑ ุฃู ุงูุชุณุฌูู ุฃู ุงูุฎุฑูุฌ ูู ูุงูุฐุฉ ุงูููุตุฉ ูุนุฑุถ ุญุณุงุจู ููุฅุบูุงู ุงูููุฑู. ุงููุญุชูู ูุฑุงูุจ
            ุฅููุชุฑูููุงู.</span>
    </div>


    <div class="container">
        <div style="margin-top: 2rem;">
            <h1>ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ</h1>
            <p>ุงุฎุชุฑ ุงููุงุฏุฉ ููุฏุฎูู ุฅูู ุงููุญุงุถุฑุงุช ูุงููููุงุช</p>
        </div>

        <div class="dashboard-grid">
            <!-- Subject 1 -->
            <a href="subject.html?id=math" class="subject-card">
                <div class="subject-icon">๐</div>
                <h2>ุงูุฑูุงุถูุงุช</h2>
                <p>Mathematics</p>
            </a>

            <!-- Subject 2 -->
            <a href="subject.html?id=geo" class="subject-card">
                <div class="subject-icon">๐</div>
                <h2>ุงูุฌุบุฑุงููุง</h2>
                <p>Geography</p>
            </a>

            <!-- Subject 3 -->
            <a href="subject.html?id=eng" class="subject-card">
                <div class="subject-icon">๐ฌ๐ง</div>
                <h2>ุงููุบุฉ ุงูุฅูุฌููุฒูุฉ</h2>
                <p>English</p>
            </a>

            <!-- Subject 4 -->
            <a href="subject.html?id=fr" class="subject-card">
                <div class="subject-icon">๐ซ๐ท</div>
                <h2>ุงููุบุฉ ุงููุฑูุณูุฉ</h2>
                <p>French</p>
            </a>
        </div>

        <footer style="margin-top: 3rem; text-align: center; padding-bottom: 2rem;">
            <p style="color: #888; font-size: 0.9rem;">ยฉ ELMOHASEB ACADEMY 2026. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
            <div class="developer-credit">
                BY <span class="developer-name">MAHMOUD REDA</span>
                <span class="developer-phone">01004897420</span>
            </div>
        </footer>

    </div>
</body>

</html>